<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>按分组选出值最大的n行数据 | 书到用时方恨少，砖到搬时才知沉</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">按分组选出值最大的n行数据</h1><a id="logo" href="/.">书到用时方恨少，砖到搬时才知沉</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">按分组选出值最大的n行数据</h1><div class="post-meta">May 18, 2017</div><div class="post-content"><p>介绍几种选出值最大的n行数据的方法<br><a id="more"></a></p>
<h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>有一张表，结构如下：id为自增主键，innodb 引擎</p>
<table>
<thead>
<tr>
<th>id（PK,AI)</th>
<th>product_id</th>
<th>product_name</th>
<th>product_price</th>
<th>shop_id（FK)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1000</td>
<td>23134</td>
<td>‘bread’</td>
<td>2.30</td>
<td>13421</td>
</tr>
<tr>
<td>1001</td>
<td>23135</td>
<td>‘beaf’</td>
<td>7.30</td>
<td>13421</td>
</tr>
<tr>
<td>1002</td>
<td>23154</td>
<td>‘apple’</td>
<td>3.30</td>
<td>13421</td>
</tr>
<tr>
<td>1003</td>
<td>39134</td>
<td>‘rice’</td>
<td>1.30</td>
<td>13422</td>
</tr>
<tr>
<td>1004</td>
<td>73234</td>
<td>‘chicken’</td>
<td>4.30</td>
<td>13422</td>
</tr>
<tr>
<td>1005</td>
<td>832134</td>
<td>‘orange’</td>
<td>2.50</td>
<td>13422</td>
</tr>
<tr>
<td>1006</td>
<td>75139</td>
<td>‘banana’</td>
<td>6.30</td>
<td>13423</td>
</tr>
<tr>
<td>1007</td>
<td>52128</td>
<td>‘melon’</td>
<td>1.20</td>
<td>13423</td>
</tr>
<tr>
<td>1008</td>
<td>21114</td>
<td>‘strawberry’</td>
<td>4.90</td>
<td>13423</td>
</tr>
</tbody>
</table>
<p>DDL 如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`product_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`product_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`product_price`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`shop_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`index2`</span> (<span class="string">`product_id`</span>,<span class="string">`shop_id`</span>,<span class="string">`product_price`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">11</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure></p>
<p>测试数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">29</span>, <span class="string">'prod_1.2'</span>, <span class="number">1.2</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">12</span>, <span class="string">'prod_2.2'</span>, <span class="number">2.2</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">14</span>, <span class="string">'prod_200_1.5'</span>, <span class="number">1.5</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">15</span>, <span class="string">'prod_200_11.5'</span>, <span class="number">11.5</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">16</span>, <span class="string">'prod_200_12.3'</span>, <span class="number">12.3</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">17</span>, <span class="string">'prod_300_220.1'</span>, <span class="number">220.1</span>, <span class="number">300</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">18</span>, <span class="string">'prod_300_100.2'</span>, <span class="number">100.2</span>, <span class="number">300</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">19</span>, <span class="string">'prod_300_300'</span>, <span class="number">300</span>, <span class="number">300</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">21</span>, <span class="string">'prod_100_120'</span>, <span class="number">120</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.product (product_id, product_name, product_price, shop_id) <span class="keyword">VALUES</span> (<span class="number">91</span>, <span class="string">'prod_400_1.2'</span>, <span class="number">1.2</span>, <span class="number">400</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="第一个问题：查出每个店铺价格最贵的商品"><a href="#第一个问题：查出每个店铺价格最贵的商品" class="headerlink" title="第一个问题：查出每个店铺价格最贵的商品"></a>第一个问题：查出每个店铺价格最贵的商品</h2><p>这个问题非常简单，因为 MySQL 有一个 Max 函数可以计算出最大的值，并按照 shop_id group 即可：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  product_id, product_name, shop_id, <span class="keyword">MAX</span>(product_price)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    product</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> shop_id;</span><br></pre></td></tr></table></figure></p>
<p><strong>要是真这么以为的话，那就要铸成大错了！</strong>这里有一个误区，MAX 函数和 group by 配合使用确实能计算出每个商店最贵的商品，但是其他列的数据理论上是和这个最大值无关的，如果结果正确了，一定是因为巧合！</p>
<p>说到这里，就顺带记录一下一条查询（select）语句中各个关键字执行的顺序：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(8) <span class="keyword">SELECT</span> (<span class="number">9</span>) <span class="keyword">DISTINCT</span>&lt;select_list&gt;</span><br><span class="line">(<span class="number">1</span>) <span class="keyword">FROM</span> &lt;left_table&gt;</span><br><span class="line">(<span class="number">3</span>) &lt;join_type&gt; <span class="keyword">JOIN</span> &lt;right_table&gt;</span><br><span class="line">(<span class="number">2</span>) <span class="keyword">ON</span> &lt;join_condition&gt;</span><br><span class="line">(<span class="number">4</span>) <span class="keyword">WHERE</span> &lt;where_condition&gt;</span><br><span class="line">(<span class="number">5</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> &lt;group_by_list&gt;</span><br><span class="line">(<span class="number">6</span>) <span class="keyword">WITH</span></span><br><span class="line">(<span class="number">7</span>) <span class="keyword">HAVING</span></span><br><span class="line">(<span class="number">10</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> &lt;order_by&gt;</span><br><span class="line">(<span class="number">11</span>) <span class="keyword">LIMIT</span></span><br></pre></td></tr></table></figure></p>
<p><code>GROUP BY</code> 是先于 <code>SELECT</code> 执行的，而 <code>MAX</code> 函数会根据 <code>GROUP BY</code> 的条件去对结果进行聚合计算出按照该列分类的每一类中的最大值，其他列与这个值并不具备相关性，也无法做到相关性。所以上面那个是错误的。</p>
<p>一种思路是这样的：先将 shop_id 和 max(product_price) 选出来，再根据结果与表自身做一次连接，连接条件就是 shop_id 和 product_price。SQL 如下，<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    p2.*</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        shop_id, <span class="keyword">MAX</span>(product_price) <span class="keyword">AS</span> product_price</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        product p1</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> shop_id) <span class="keyword">AS</span> p1</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">    product p2 <span class="keyword">ON</span> p2.shop_id = p1.shop_id</span><br><span class="line">        <span class="keyword">AND</span> p2.product_price = p1.product_price</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> p2.id;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/lephp/lephp.github.io/master/images/201705/select-max-value-1-no-index.png" alt="执行计划(未添加索引)"></p>
<p><img src="https://raw.githubusercontent.com/lephp/lephp.github.io/master/images/201705/select-max-value-solution-1-indexed.png" alt="执行计划(已添加索引)"></p>
<p>还有一种思路是：使用关联子查询，这种方式比上一种的效率要高很多，子查询将每个商店的最大值取出来，放入主查询的 where 条件，SQL 如下，<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    product</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    product_price <span class="keyword">IN</span> (<span class="keyword">SELECT</span></span><br><span class="line">            <span class="keyword">MAX</span>(product_price)</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            product</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> shop_id)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span>;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/lephp/lephp.github.io/master/images/201705/select-max-value-solution-2-no-index.png" alt="执行计划(未添加索引)"></p>
<p><img src="https://raw.githubusercontent.com/lephp/lephp.github.io/master/images/201705/select-max-value-solution-2-indexed.png" alt="执行计划(已添加索引)"></p>
<p>很显然第二种方式的查询效率更高，至于怎么建立索引，我这里选取了 shop_id 和 product_price 两个字段建立BTREE联合索引，而索引选择的原则我现在还不是很有经验，只是凭直觉，从 EXPLAIN 的结果上看的话，还是不错的。</p>
<h2 id="第二个问题：每个店铺价格最贵的-2-件商品"><a href="#第二个问题：每个店铺价格最贵的-2-件商品" class="headerlink" title="第二个问题：每个店铺价格最贵的 2 件商品"></a>第二个问题：每个店铺价格最贵的 2 件商品</h2><p>看到这个题目，我第一反应是，要按照每个店铺去聚集计算出最大的两行，然后再使用 union join 把所有结果合并起来，显然这种做法缺乏灵活性，如果我有一千个商铺，那岂不是要有999个 union join…ヽ(*。&gt;Д&lt;)o゜可怕！</p>
<p>上面第一题中使用 <code>product_price</code> 与子查询做连接查出最贵的，同样可以查出第二贵的商品，具体实现 SQL 如下，</p>
<h3 id="解法-1"><a href="#解法-1" class="headerlink" title="解法 1"></a>解法 1</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  <span class="string">`product`</span> p1</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  <span class="string">`product_price`</span> = (<span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="string">`product_price`</span>)</span><br><span class="line">                     <span class="keyword">FROM</span></span><br><span class="line">                       <span class="string">`product`</span> p2</span><br><span class="line">                     <span class="keyword">WHERE</span></span><br><span class="line">                       <span class="string">`p2`</span>.<span class="string">`shop_id`</span> = <span class="string">`p1`</span>.<span class="string">`shop_id`</span>)</span><br><span class="line">  <span class="keyword">OR</span> <span class="string">`product_price`</span> = (<span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="string">`product_price`</span>)</span><br><span class="line">      <span class="keyword">FROM</span></span><br><span class="line">        <span class="string">`product`</span> p3</span><br><span class="line">      <span class="keyword">WHERE</span> <span class="string">`p3`</span>.shop_id = <span class="string">`p1`</span>.shop_id <span class="keyword">AND</span></span><br><span class="line">            <span class="string">`p3`</span>.<span class="string">`product_price`</span> &lt; (<span class="keyword">SELECT</span> <span class="keyword">MAX</span>(product_price)</span><br><span class="line">                                    <span class="keyword">FROM</span></span><br><span class="line">                                      <span class="string">`product`</span> p4</span><br><span class="line">                                    <span class="keyword">WHERE</span></span><br><span class="line">                                      <span class="string">`p4`</span>.<span class="string">`shop_id`</span> = <span class="string">`p3`</span>.<span class="string">`shop_id`</span>)</span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span> p3.shop_id)</span><br></pre></td></tr></table></figure>
<p>结构还是很清晰的，先查出最高的和第二高的，不过这种解法并不是很优雅：<br><img src="https://raw.githubusercontent.com/lephp/lephp.github.io/master/images/201705/select-max-n-value-solution-1-indexed.png" alt="执行计划"></p>
<p>一共使用了三个 <code>DEPENDENCY SUBQUERY</code>，可以说是非常复杂的。而且当需求一变，这个 SQL 就无效了，我个人认为使用频次高的查询要尽量具有通用性，这样在性能优化的时候也具有更大的操作空间。</p>
<p>TOP N 条记录，用子查询怎么解决？</p>
<h3 id="解法-2-1"><a href="#解法-2-1" class="headerlink" title="解法 2-1"></a>解法 2-1</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="string">`p1`</span>.*</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`product`</span> p1</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    <span class="number">2</span> &gt; (<span class="keyword">SELECT</span></span><br><span class="line">            <span class="keyword">COUNT</span>(*)</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            <span class="string">`product`</span> p2</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            <span class="string">`p2`</span>.<span class="string">`shop_id`</span> = <span class="string">`p1`</span>.<span class="string">`shop_id`</span></span><br><span class="line">                <span class="keyword">AND</span> <span class="string">`p2`</span>.<span class="string">`product_price`</span> &gt; <span class="string">`p1`</span>.<span class="string">`product_price`</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`p1`</span>.<span class="string">`shop_id`</span> , <span class="string">`p1`</span>.<span class="string">`product_price`</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>
<p>上述解法的核心理念是用一个关联子查询查出 <code>product_price</code> 列的所有值中，值比其大的行总数小于2(或者n)的所有行，子查询与表达式作为 where 条件返回 <code>TRUE</code> 或者 <code>FALSE</code>，最后返回的是返回 <code>TRUE</code> 的所有行。</p>
<p>更通俗一点解释，要查最大的两行，遍历到其中一行的时候，将其和表中每一行对应的列的值做一一比较，总数小于2的话，那说明它是最大的两个值之一，所以就命中选择条件。</p>
<p>这种思路还可以这么写，使用 <code>HAVING</code> 来控制 <code>TRUE/FALSE</code></p>
<h3 id="解法-2-2"><a href="#解法-2-2" class="headerlink" title="解法 2-2"></a>解法 2-2</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="string">`p1`</span>.*</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`test`</span>.<span class="string">`product`</span> p1</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    <span class="keyword">EXISTS</span>( <span class="keyword">SELECT</span></span><br><span class="line">            <span class="keyword">COUNT</span>(*)</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            <span class="string">`test`</span>.<span class="string">`product`</span> p2</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            <span class="string">`p2`</span>.<span class="string">`shop_id`</span> = <span class="string">`p1`</span>.<span class="string">`shop_id`</span></span><br><span class="line">                <span class="keyword">AND</span> <span class="string">`p2`</span>.<span class="string">`product_price`</span> &gt; <span class="string">`p1`</span>.<span class="string">`product_price`</span></span><br><span class="line">        <span class="keyword">HAVING</span> <span class="keyword">COUNT</span>(*) &lt; <span class="number">2</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`p1`</span>.<span class="string">`shop_id`</span>, <span class="string">`p1`</span>.<span class="string">`product_price`</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/MySQL-SQL-groupby/">MySQL SQL groupby</a></div><div class="post-nav"><a class="pre" href="/2017/05/26/PHP7-FPM-internels/">PHP7 FPM 启动源码分析&lt;一&gt;</a><a class="next" href="/2017/05/17/http-post-methods-comparison/">HTTP POST 表单提交方式介绍</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://vividcoding.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interviews/" style="font-size: 15px;">interviews</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/mysql-查询优化/" style="font-size: 15px;">mysql 查询优化</a> <a href="/tags/php7-阅读源码/" style="font-size: 15px;">php7 阅读源码</a> <a href="/tags/MySQL-SQL-groupby/" style="font-size: 15px;">MySQL SQL groupby</a> <a href="/tags/opcache-php-optimization/" style="font-size: 15px;">opcache php optimization</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/03/08/Why-event-sourcing-so-incrediable/">事件溯源：它是什么，为何这么厉害</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/02/A-small-tip-about-mysql-latin1-charset/">MySQL latin1 字符集引起的一个小问题分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/15/why-using-an-integer-to-select-varchar-cause-a-full-table-scan/">为什么使用INT型数据查询varchar字段会导致全表扫描</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/26/PHP7-FPM-internels/">PHP7 FPM 启动源码分析<一></a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/18/select-max-top-n-rows-with-groupby/">按分组选出值最大的n行数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/17/http-post-methods-comparison/">HTTP POST 表单提交方式介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/17/2017-interviews/">2017 面试记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/18/things-about-opcache/">OPCache 工作机制</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">书到用时方恨少，砖到搬时才知沉.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>