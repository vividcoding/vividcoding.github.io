<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>为什么使用INT型数据查询varchar字段会导致全表扫描 | 书到用时方恨少，砖到搬时才知沉</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">为什么使用INT型数据查询varchar字段会导致全表扫描</h1><a id="logo" href="/.">书到用时方恨少，砖到搬时才知沉</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">为什么使用INT型数据查询varchar字段会导致全表扫描</h1><div class="post-meta">May 15, 2018</div><div class="post-content"><p>一个简单的查询语句引发的血案。<br><a id="more"></a></p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">form</span> <span class="string">`db_articles`</span>.<span class="string">`tbl_articles`</span> <span class="keyword">where</span> article_id=<span class="number">2018010100000</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h3 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`db_articles`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET latin1 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tbl_articles`</span> (</span><br><span class="line">  <span class="string">`article_id`</span> <span class="built_in">varchar</span>(<span class="number">14</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span></span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`article_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=latin1</span><br></pre></td></tr></table></figure>
<p>查询的语句非常简单，但是却存在巨大的隐患，因为无法用到索引会导致执行查询语句需要扫描整张表的数据，如果这张表非常大的话会导致整个数据库服务器I/O被占满，接近宕机状态。</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><h3 id="查询结果对吗？"><a href="#查询结果对吗？" class="headerlink" title="查询结果对吗？"></a>查询结果对吗？</h3><p>首先，这个场景下这条语句能否查出结果呢？不一定，这个完全需要在业务侧保证生成的<code>article_id</code>字段唯一，不然就会导致下面的情况：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`db_articles`</span>.<span class="string">`tbl_articles`</span> (<span class="string">`article_id`</span>) <span class="keyword">VALUES</span> (<span class="string">'20180515000000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`db_articles`</span>.<span class="string">`tbl_articles`</span> (<span class="string">`article_id`</span>) <span class="keyword">VALUES</span> (<span class="string">'20180515000001'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`db_articles`</span>.<span class="string">`tbl_articles`</span> (<span class="string">`article_id`</span>) <span class="keyword">VALUES</span> (<span class="string">'020180051500'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`db_articles`</span>.<span class="string">`tbl_articles`</span> (<span class="string">`article_id`</span>) <span class="keyword">VALUES</span> (<span class="string">'20180051500'</span>);</span><br></pre></td></tr></table></figure></p>
<p>查询语句如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> db_articles;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl_articles <span class="keyword">where</span> article_id=<span class="number">20180051500</span>;</span><br></pre></td></tr></table></figure></p>
<p>查询结果如下：<br>| article_id |<br>| - |<br>| 020180051500 |<br>|    20180051500 |</p>
<p>可以看出，查询结果不一定是预期结果，这条查询的问题在于 where 条件里 article_id=20180051500, 而 mysql 认为 “020180051500” = 20180051500，因此查出了错误的结果。既然知道该字段类型是VARCHAR，那在查询的时候一定要保证 where 条件的值在程序中以字符串类型发送到数据库。</p>
<p>正确的查询：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> db_articles;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl_articles_2 <span class="keyword">where</span> article_id=<span class="string">"20180051500"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl_articles_2 <span class="keyword">where</span> article_id=<span class="keyword">CONCAT</span>(<span class="number">20180051500</span>);</span><br></pre></td></tr></table></figure></p>
<p>再来看一个官方提供的例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">'18015376320243458'</span> = <span class="number">18015376320243458</span>;</span><br><span class="line">        -&gt; 1</span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">'18015376320243459'</span> = <span class="number">18015376320243459</span>;</span><br><span class="line">        -&gt; 0</span><br></pre></td></tr></table></figure>
<p>上面这个例子我在自己装的MySQL版本上已经无法得到官方提供的结果，不过用下面的测试可以得出相似的结果：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">'999999999999999999999999999999999999999999999999999999999999999999999999999999999'</span>=<span class="number">999999999999999999999999999999999999999999999999999999999999999999999999999999999</span></span><br><span class="line">    -&gt; <span class="number">1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">'1000000000000000000000000000000000000000000000000000000000000000000000000000000000'</span>=<span class="number">1000000000000000000000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line">    -&gt; <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>上面第一句，81位数字，都是9，比较出来相等，但是+1之后就不等了。</p>
<h3 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h3><p>MySQL文档中的解释：<a href="https://dev.mysql.com/doc/refman/5.7/en/type-conversion.html" target="_blank" rel="noopener">12.2 Type Conversion in Expression Evaluation</a></p>
<blockquote>
<p>If one or both arguments are NULL, the result of the comparison is NULL, except for the NULL-safe &lt;=&gt; equality comparison operator. For NULL &lt;=&gt; NULL, the result is true. No conversion is needed.</p>
</blockquote>
<blockquote>
<p>If both arguments in a comparison operation are strings, they are compared as strings.</p>
</blockquote>
<blockquote>
<p>If both arguments are integers, they are compared as integers.</p>
</blockquote>
<blockquote>
<p>Hexadecimal values are treated as binary strings if not compared to a number.</p>
</blockquote>
<blockquote>
<p>If one of the arguments is a TIMESTAMP or DATETIME column and the other argument is a constant, the constant is converted to a timestamp before the comparison is performed. <strong>This is done to be more ODBC-friendly. This is not done for the arguments to IN(). To be safe, always use complete datetime, date, or time strings when doing comparisons</strong>. For example, to achieve best results when using BETWEEN with date or time values, use CAST() to explicitly convert the values to the desired data type.</p>
</blockquote>
<blockquote>
<p>A single-row subquery from a table or tables is not considered a constant. For example, if a subquery returns an integer to be compared to a DATETIME value, the comparison is done as two integers. The integer is not converted to a temporal value. To compare the operands as DATETIME values, use CAST() to explicitly convert the subquery value to DATETIME.</p>
</blockquote>
<blockquote>
<p>If one of the arguments is a decimal value, comparison depends on the other argument. The arguments are compared as decimal values if the other argument is a decimal or integer value, or as floating-point values if the other argument is a floating-point value.</p>
</blockquote>
<blockquote>
<p><strong>In all other cases, the arguments are compared as floating-point (real) numbers.</strong></p>
</blockquote>
<ul>
<li>两个参数至少有一个是 NULL 时，比较的结果也是 NULL，例外是使用 &lt;=&gt; 对两个 NULL 做比较时会返回 1，这两种情况都不需要做类型转换</li>
<li>两个参数都是字符串，会按照字符串来比较，不做类型转换</li>
<li>两个参数都是整数，按照整数来比较，不做类型转换</li>
<li>十六进制的值和非数字做比较时，会被当做二进制串，和数字做比较时会按下面的规则处理</li>
<li>有一个参数是 TIMESTAMP 或 DATETIME，并且另外一个参数是常量，常量会被转换为 timestamp</li>
<li>有一个参数是 decimal 类型，如果另外一个参数是 decimal 或者整数，会将整数转换为 decimal 后进行比较，如果另外一个参数是浮点数，则会把 decimal 转换为浮点数进行比较</li>
<li>所有其他情况下，两个参数都会被转换为浮点数再进行比较</li>
</ul>
<p>再参考 <a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-indexes.html" target="_blank" rel="noopener">8.3.1 How MySQL Uses Indexes</a>中提到的：</p>
<blockquote>
<p>Comparison of dissimilar columns (comparing a string column to a temporal or numeric column, for example) may prevent use of indexes if values cannot be compared directly without conversion. For a given value such as 1 in the numeric column, it might compare equal to any number of values in the string column such as ‘1’, ‘ 1’, ‘00001’, or ‘01.e1’. <strong>This rules out use of any indexes for the string column</strong>.</p>
</blockquote>
<p>如果做值的比较时需要根据上面的机制做类型转换的话，考虑到1可能等于’1’,’ 1’,’00001’甚至 ‘01.e1’,因此非常大的概率导致无法使用到索引。但是如果列类型是数字型，where条件是字符串的情况是可以用到索引的，因为字符串会被转换成数字，而数字之间比较会出现非确定结果的情况。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>mysql 的隐式类型转换给使用者带来的方便可能伴随着非常沉重的代价，需要多加注意，尤其是随着业务发展，老业务DB需要变更字段类型（int转成varchar还是比较常见的)时需要非常慎重。</p>
</div><div class="tags"><a href="/tags/mysql-查询优化/">mysql 查询优化</a></div><div class="post-nav"><a class="pre" href="/2018/09/02/A-small-tip-about-mysql-latin1-charset/">MySQL latin1 字符集引起的一个小问题分析</a><a class="next" href="/2017/05/26/PHP7-FPM-internels/">PHP7 FPM 启动源码分析&lt;一&gt;</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://vividcoding.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interviews/" style="font-size: 15px;">interviews</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/mysql-查询优化/" style="font-size: 15px;">mysql 查询优化</a> <a href="/tags/MySQL-SQL-groupby/" style="font-size: 15px;">MySQL SQL groupby</a> <a href="/tags/php7-阅读源码/" style="font-size: 15px;">php7 阅读源码</a> <a href="/tags/opcache-php-optimization/" style="font-size: 15px;">opcache php optimization</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/02/A-small-tip-about-mysql-latin1-charset/">MySQL latin1 字符集引起的一个小问题分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/15/why-using-an-integer-to-select-varchar-cause-a-full-table-scan/">为什么使用INT型数据查询varchar字段会导致全表扫描</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/26/PHP7-FPM-internels/">PHP7 FPM 启动源码分析<一></a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/18/select-max-top-n-rows-with-groupby/">按分组选出值最大的n行数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/17/http-post-methods-comparison/">HTTP POST 表单提交方式介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/17/2017-interviews/">2017 面试记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/18/things-about-opcache/">OPCache 工作机制</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">书到用时方恨少，砖到搬时才知沉.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>